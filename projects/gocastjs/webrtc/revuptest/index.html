<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="js/jquery-1.8.1.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript" src="js/jquery.utils.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript" src="/scripts/strophe.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript" src="js/strophe_connection.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript">
            var pluginmap = {};
            var pendingcandidates = {};
            var localstream = null;
            var conn = null;
            var onlocalplayerloaded = function() {
                var plugin = document.getElementById('localPlayer'),
                    constraints = {
                        video: true,
                        audio: true,
                        videoconstraints: {
                            videoin: plugin.videoinopts['default'],
                            webrtc: {
                                mandatory: {
                                    minWidth: '160',
                                    maxWidth: '160',
                                    minHeight: '120',
                                    maxHeight: '120',
                                    minFrameRate: '14',
                                    maxFrameRate: '14'
                                }
                            }
                        },
                        audioconstraints: {
                            audioin: plugin.audioinopts[0],
                            audioout: plugin.audiooutopts[0]
                        }
                    };

                plugin.getUserMedia(constraints, function(stream) {
                    var i, j = parseInt($.urlvars.u), other;

                    console.log('Success: ', stream);
                    localstream = stream;
                    plugin.init('localPlayer', [], null);
                    plugin.addStream(stream);
                    plugin.createOffer(function(desc) {
                        console.log('CreateOffer: ', desc);
                        plugin.setLocalDescription('offer', desc, function() {
                            console.log('SetLocalDescription: Success');
                            plugin.source = stream;
                            conn.send($pres());
                            for (i=1; i<4; i++) {
                                if (j != i) {
                                    other = 'test' + i + '@dev.gocast.it';
                                    conn.send($pres({to: other}));
                                }
                            }
                            console.log('Online: ', conn.getJid());
                        }, function(error) {
                            console.log('SetLocalDescription: ', error);
                        });
                    }, function(error) {
                        console.log('CreateOffer: ', error);
                    });
                }, function(msg) {alert(msg);});
            };

            var callernegotiationcallback = function(fulljid, peerconnection) {
                return function() {
                    peerconnection.createOffer(function(sdp) {
                        console.log('Peer [' + fulljid + ']: createoffer: ' + sdp);
                        peerconnection.setLocalDescription('offer', sdp, function() {
                            console.log('Peer [' + fulljid + ']: setLocalDescription success, ' +
                                        'sending offer...');
                            conn.send($msg({to: fulljid, type: 'chat'}).c('offer').t(sdp));
                        }, function(error) {
                            console.log('Peer [' + fulljid + ']: setLocalDescription error: ' + error);
                        });
                    }, function(error) {
                        console.log('Peer [' + fulljid + ']: createOffer error: ' + error);
                    });
                };
            };

            var calleenegotiationcallback = function(fulljid, peerconnection, sdp) {
                return function() {
                    peerconnection.setRemoteDescription('offer', sdp, function() {
                        console.log('Peer [' + fulljid + ']: setRemoteDescription success, ' +
                                    'creating answer...');
                        peerconnection.createAnswer(function(sdp) {
                            console.log('Peer [' + fulljid + ']: createanswer: ' + sdp);
                            peerconnection.setLocalDescription('answer', sdp, function() {
                                console.log('Peer [' + fulljid + ']: setLocalDescription success, ' +
                                            'sending answer (offer/answer done)...');
                                conn.send($msg({to: fulljid, type: 'chat'}).c('answer').t(sdp));
                            }, function(error) {
                                console.log('Peer [' + fulljid + ']: setLocalDescription error: '
                                            + error);
                            });
                        }, function(error) {
                            console.log('Peer [' + fulljid + ']: createAnswer error: ' + error);
                        });
                    }, function(error) {
                        console.log('Peer [' + fulljid + ']: setRemoteDescription error: ' + error);
                    });
                };
            };

            var initpeerconnection = function(fulljid, negotiationCallback, sdp) {
                var peerconnection = null, iceservers = [];

                hangupOnPeer(fulljid);
                if (!pluginmap['peer0']) {
                    $('#peer0').html('<object class="peerconn" type="application/x-gocastplayer" width="0" height="0"></object>');
                    peerconnection = $('body > #peer0 > .peerconn').get(0);
                    pluginmap['peer0'] = fulljid;
                } else if (!pluginmap['peer1']) {
                    $('#peer1').html('<object class="peerconn" type="application/x-gocastplayer" width="0" height="0"></object>');
                    peerconnection = $('body > #peer1 > .peerconn').get(0);
                    pluginmap['peer1'] = fulljid;
                }

                peerconnection.onaddstream = function(stream) {
                    console.log('Peer [' + fulljid + ']: Added remote stream ' + stream.label);
                    peerconnection.width = 320;
                    peerconnection.height = 240;
                    peerconnection.source = stream;
                };

                if (negotiationCallback) {
                     peerconnection.onnegotiationneeded = negotiationCallback(fulljid, peerconnection, sdp);
                }

                peerconnection.onstatechange = function(state) {
                    console.log('Peer [' + fulljid + ']: sigstate = ' + state);
                    if (pendingcandidates[fulljid] && 'stable' === state) {
                        for (i=0; i<pendingcandidates[fulljid].length; i++) {
                            c = pendingcandidates[fulljid][i];
                            console.log(peerconnection.addIceCandidate(c.sdp_mid,
                                                                       c.sdp_mline_index,
                                                                       c.sdp));
                        }
                        delete pendingcandidates[fulljid];
                    }
                };

                peerconnection.onicechange = function(state) {
                    console.log('Peer [' + fulljid + ']: icestate = ' + state);
                };

                peerconnection.ongatheringchange = function(state) {
                    console.log('Peer [' + fulljid + ']: icegatheringstate = ' + state);
                };

                if ($.urlvars.turn) {
                    iceservers.push({uri: 'turn:manjeshtest2@dev.gocast.it:3478', password: 'manjeshpass2'});
                } else {
                    iceservers.push({uri: 'stun:stun.l.google.com:19302'});
                }
                console.log('ICESERVERS: ' + JSON.stringify(iceservers));

                peerconnection.init(fulljid, iceservers, function(sdp) {
                    if ('' !== sdp) {
                        console.log('Peer [' + fulljid + ']: onice: ' + sdp.replace(/\r\n/, ''));
                        conn.send($msg({to: fulljid, type: 'chat'}).c('candidate')
                                  .t(sdp.replace(/\r\n/, '')));
                    } else {
                        console.log('Peer [' + fulljid + ']: Candidate gathering done');
                    }
                });

                peerconnection.addStream(localstream);
            };

            var callpeer = function(fulljid) {
                initpeerconnection(fulljid, callernegotiationcallback);
            };

            var acceptanswerfrompeer = function(fulljid, sdp) {
                var id = pluginmap['peer0'] === fulljid ? 'peer0' : (pluginmap['peer1'] === fulljid ? 'peer1' : 'dummy'),
                    peerconnection = $('body > #' + id + ' > .peerconn').get(0), i, c;

                if (peerconnection) {
                    console.log('Peer [' + fulljid + ']: answer: ' + sdp);
                    peerconnection.setRemoteDescription('answer', sdp, function() {
                        console.log('Peer [' + fulljid + ']: setRemoteDescription success, ' +
                                    'offer/answer done...');
                    }, function(error) {
                        console.log('Peer [' + fulljid + ']: setRemoteDescription error: ' + error);
                    });
                }
            };

            var acceptofferfrompeer = function(fulljid, sdp) {
                initpeerconnection(fulljid, calleenegotiationcallback, sdp);
            };

            var addcandidateforpeer = function(fulljid, sdp) {
                var id = pluginmap['peer0'] === fulljid ? 'peer0' : (pluginmap['peer1'] === fulljid ? 'peer1' : 'dummy'),
                    peerconnection = $('body > #' + id + ' > .peerconn').get(0), c = JSON.parse(sdp);

                if (peerconnection) {
                    console.log('Peer [' + fulljid + ']: addcandidate: ' + sdp);
                    if ('stable' === peerconnection.signalingState) {
                        console.log(peerconnection.addIceCandidate(c.sdp_mid, c.sdp_mline_index, c.sdp));
                    } else {
                        if (!pendingcandidates[fulljid]) {
                            pendingcandidates[fulljid] = [];
                        }
                        pendingcandidates[fulljid].push(c);
                        console.log('PendingCandidates: ', pendingcandidates);
                    }
                }
            };

            var hangupOnPeer = function(fulljid) {
                var id = pluginmap['peer0'] === fulljid ? 'peer0' : (pluginmap['peer1'] === fulljid ? 'peer1' : 'dummy'), container = $('body > #' + id).get(0);

                if (container) {
                    container.removeChild(container.lastChild);
                }
                delete pluginmap[id];
            }

            var addStanzaHandlers = function() {
                conn.addHandler(function(pres) {
                    if (!$(pres).attr('type')) {
                        console.log('Calling: ', $(pres).attr('from'));
                        if (Strophe.getBareJidFromJid(conn.getJid()) !== 
                            Strophe.getBareJidFromJid($(pres).attr('from'))) {
                            callpeer($(pres).attr('from'));
                        }
                    } else if ('unavailable' === $(pres).attr('type')) {
                        console.log('Hanging up on: ', $(pres).attr('from'));
                        hangupOnPeer($(pres).attr('from'));
                    }
                    return true;
                }, null, 'presence');

                conn.addHandler(function(msg) {
                    if ($(msg).find('offer').length) {
                        acceptofferfrompeer($(msg).attr('from'),
                                            $(msg).children('offer').text());
                    } else if ($(msg).find('answer').length) {
                        acceptanswerfrompeer($(msg).attr('from'),
                                             $(msg).children('answer').text());
                    } else if ($(msg).find('candidate').length) {
                        addcandidateforpeer($(msg).attr('from'),
                                            $(msg).children('candidate').text()
                                                  .replace(/&quot;/g, '"'));
                    }
                    return true;
                }, null, 'message', 'chat');
            };

            $(document).on('online', function() {
                addStanzaHandlers = addStanzaHandlers || function() {
                    console.log('Empty addStanzaHandlers()');
                };

                addStanzaHandlers();
                addStanzaHandlers = null;
                $('body > #preview').append('<object id="localPlayer" type="application/x-gocastplayer" width="320" height="240">' +
                                            '<param name="onload" value="onlocalplayerloaded"></param></object>');
            });

            $(document).on('offline', function() {
                if (conn.hasSavedRegisteredLoginInfo()) {
                    conn.autoConnect();
                } else {
                    conn.connect({
                        username: 'test' + $.urlvars.u,
                        password: 'test' + $.urlvars.u + 'password'
                    });
                }
            });

            $(document).ready(function() {
                conn = new GoCastJS.StropheConnection({
                    boshurl: '/xmpp-httpbind',
                    xmppserver: 'dev.gocast.it',
                    statusCallback: function(status) {
                        if (Strophe.Status.CONNECTED === status) {
                            $(document).trigger('online', conn);
                        } else if (Strophe.Status.ATTACHED === status) {
                            conn.forgetReconnectInfo();
                            conn.disconnect();
                        } else if (Strophe.Status.TERMINATED === status) {
                            $(document).trigger('offline', conn);
                        }
                    }
                });

                $(document).trigger('offline');
            });
        </script>
    </head>
    <body>
        <div id="preview"></div>
        <div id="peer0"></div>
        <div id="peer1"></div>
    </body>
</html>