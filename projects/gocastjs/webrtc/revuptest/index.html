<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="js/jquery-1.8.1.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript" src="js/jquery.utils.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript" src="/scripts/strophe.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript" src="js/strophe_connection.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript" src="js/peerconnection.js?GOCASTTIMESTAMP"></script>
        <script type="text/javascript">
            var pluginmap = {},
                localstream = null,
                conn = null,
                iceservers = {
                    stun: [{uri: 'stun:stun.l.google.com:19302'}],
                    turn: [{uri: 'turn:manjeshtest2@dev.gocast.it:3478', password: 'manjeshpass2'}]
                },
                peerconnections = {};
                remoteplayertmpl = '<object class="peerconn" type="application/x-gocastplayer" width="0" height="0"></object>',
                onlocalplayerloaded = function() {
                var plugin = document.getElementById('localPlayer'),
                    options = new GoCastJS.UserMediaOptions({
                        video: $.urlvars.video || false,
                        audio: $.urlvars.audio || false,
                        videoconstraints: {
                            videoin: plugin.videoinopts['default'],
                            webrtc: {
                                mandatory: {
                                    minWidth: '160',
                                    maxWidth: '160',
                                    minHeight: '120',
                                    maxHeight: '120',
                                    minFrameRate: '14',
                                    maxFrameRate: '14'
                                }
                            }
                        },
                        audioconstraints: {
                            audioin: plugin.audioinopts[0],
                            audioout: plugin.audiooutopts[0]
                        }
                    }, plugin);

                GoCastJS.getUserMedia(options, function(stream) {
                    var i, j = parseInt($.urlvars.u), other;

                    localstream = stream;
                    conn.send($pres());
                    for (i=1; i<4; i++) {
                        if (j != i) {
                            other = 'test' + i + '@dev.gocast.it';
                            conn.send($pres({to: other}));
                        }
                    }
                    console.log('Online: ', conn.getJid());
                }, function(error) { 
                    alert(error);
                });
            };

            var callernegotiationcallback = function(peerconnection) {
                return function() {
                    peerconnection.CreateOffer(function(sdp) {
                        console.log('Peer [' + peerconnection.pcid + ']: Createoffer: ' + sdp);
                        peerconnection.SetLocalDescription('offer', sdp, function() {
                            console.log('Peer [' + peerconnection.pcid + ']: SetLocalDescription success, ' +
                                        'sending offer...');
                            conn.send($msg({to: peerconnection.pcid, type: 'chat'}).c('offer').t(sdp));
                        }, function(error) {
                            console.log('Peer [' + peerconnection.pcid + ']: SetLocalDescription error: ' + error);
                        });
                    }, function(error) {
                        console.log('Peer [' + peerconnection.pcid + ']: CreateOffer error: ' + error);
                    }, { 
                        sdpconstraints: {
                            mandatory: {
                                OfferToReceiveAudio: 'true',
                                OfferToReceiveVideo: 'true'
                            }
                        }
                    });
                };
            };

            var calleenegotiationcallback = function(peerconnection, sdp) {
                return function() {
                    peerconnection.SetRemoteDescription('offer', sdp, function() {
                        console.log('Peer [' + peerconnection.pcid + ']: SetRemoteDescription success, ' +
                                    'creating answer...');
                        peerconnection.CreateAnswer(function(sdp) {
                            console.log('Peer [' + peerconnection.pcid + ']: CreateAnswer: ' + sdp);
                            peerconnection.SetLocalDescription('answer', sdp, function() {
                                console.log('Peer [' + peerconnection.pcid + ']: SetLocalDescription success, ' +
                                            'sending answer (offer/answer done)...');
                                conn.send($msg({to: peerconnection.pcid, type: 'chat'}).c('answer').t(sdp));
                            }, function(error) {
                                console.log('Peer [' + peerconnection.pcid + ']: SetLocalDescription error: '
                                            + error);
                            });
                        }, function(error) {
                            console.log('Peer [' + peerconnection.pcid + ']: CreateAnswer error: ' + error);
                        }, { 
                            sdpconstraints: {
                                mandatory: {
                                    OfferToReceiveAudio: 'true',
                                    OfferToReceiveVideo: 'true'
                                }
                            }
                        });
                    }, function(error) {
                        console.log('Peer [' + peerconnection.pcid + ']: SetRemoteDescription error: ' + error);
                    });
                };
            };

            var initpeerconnection = function(fulljid, negotiationCallback, sdp) {
                var peerconnection = null, player = null, options;

                hangupOnPeer(fulljid);
                if (!pluginmap['peer0']) {
                    $('#peer0').html(remoteplayertmpl);
                    player = $('body > #peer0 > .peerconn').get(0);
                    pluginmap['peer0'] = fulljid;
                } else if (!pluginmap['peer1']) {
                    $('#peer1').html(remoteplayertmpl);
                    player = $('body > #peer1 > .peerconn').get(0);
                    pluginmap['peer1'] = fulljid;
                }

                console.log('ICESERVERS: ' + JSON.stringify(iceservers[$.urlvars.turn || 'stun']));
                options = new GoCastJS.PeerConnectionOptions(
                    player, fulljid, iceservers[$.urlvars.turn || 'stun'],
                    function(sdp) {
                        console.log('Peer [' + fulljid + ']: onice: ' + sdp);
                        conn.send($msg({to: fulljid, type: 'chat'}).c('candidate').t(sdp));
                    },
                    function(stream) {
                        console.log('Peer [' + fulljid + ']: Added remote stream ' + stream.label);
                        peerconnection.Width(320);
                        peerconnection.Height(240);
                    },
                    function(stream) {
                        console.log('Peer [' + fulljid + ']: Removed remote stream ' + stream.label);
                        peerconnection.Width(0);
                        peerconnection.Height(0);
                    },
                    function(state) {
                        console.log('Peer [' + fulljid + ']: sigstate = ' + state);
                    },
                    function(state) {
                        console.log('Peer [' + fulljid + ']: icestate = ' + state);
                    }
                );

                peerconnection = new GoCastJS.PeerConnection(options);
                if ($.urlvars.audio || $.urlvars.video) {
                    peerconnection.AddStream(localstream, negotiationCallback(peerconnection, sdp));
                } else {
                    negotiationCallback(peerconnection, sdp)();
                }

                return peerconnection;
            };

            var callpeer = function(fulljid) {
                peerconnections[fulljid] = initpeerconnection(fulljid, callernegotiationcallback);
                
            };

            var acceptanswerfrompeer = function(fulljid, sdp) {
                if (peerconnections[fulljid]) {
                    console.log('Peer [' + fulljid + ']: answer: ' + sdp);
                    peerconnections[fulljid].SetRemoteDescription('answer', sdp, function() {
                        console.log('Peer [' + fulljid + ']: SetRemoteDescription success, ' +
                                    'offer/answer done...');
                    }, function(error) {
                        console.log('Peer [' + fulljid + ']: SetRemoteDescription error: ' + error);
                    });
                }
            };

            var acceptofferfrompeer = function(fulljid, sdp) {
                peerconnections[fulljid] = initpeerconnection(fulljid, calleenegotiationcallback, sdp);
            };

            var addcandidateforpeer = function(fulljid, sdp) {
                if (peerconnections[fulljid]) {
                    console.log('Peer [' + fulljid + ']: addcandidate: ' + sdp);
                    peerconnections[fulljid].AddIceCandidate(sdp);
                }
            };

            var hangupOnPeer = function(fulljid) {
                var id = pluginmap['peer0'] === fulljid ? 'peer0' : (pluginmap['peer1'] === fulljid ? 'peer1' : 'dummy'),
                    container = $('body > #' + id).get(0);

                if (container) {
                    container.removeChild(container.lastChild);
                }
                delete pluginmap[id];
                delete peerconnections[fulljid];
            }

            var addStanzaHandlers = function() {
                conn.addHandler(function(pres) {
                    if (!$(pres).attr('type')) {
                        if (Strophe.getBareJidFromJid(conn.getJid()) !== 
                            Strophe.getBareJidFromJid($(pres).attr('from'))) {
                            console.log('Calling: ', $(pres).attr('from'));
                            callpeer($(pres).attr('from'));
                        }
                    } else if ('unavailable' === $(pres).attr('type')) {
                        console.log('Hanging up on: ', $(pres).attr('from'));
                        hangupOnPeer($(pres).attr('from'));
                    }
                    return true;
                }, null, 'presence');

                conn.addHandler(function(msg) {
                    if ($(msg).find('offer').length) {
                        acceptofferfrompeer($(msg).attr('from'),
                                            $(msg).children('offer').text());
                    } else if ($(msg).find('answer').length) {
                        acceptanswerfrompeer($(msg).attr('from'),
                                             $(msg).children('answer').text());
                    } else if ($(msg).find('candidate').length) {
                        addcandidateforpeer($(msg).attr('from'),
                                            $(msg).children('candidate').text()
                                                  .replace(/&quot;/g, '"'));
                    }
                    return true;
                }, null, 'message', 'chat');
            };

            $(document).on('online', function() {
                addStanzaHandlers = addStanzaHandlers || function() {
                    console.log('Empty addStanzaHandlers()');
                };

                addStanzaHandlers();
                addStanzaHandlers = null;
                $('body > #preview').append('<object id="localPlayer" type="application/x-gocastplayer" width="320" height="240">' +
                                            '<param name="onload" value="onlocalplayerloaded"></param></object>');
            });

            $(document).on('offline', function() {
                if (conn.hasSavedRegisteredLoginInfo()) {
                    conn.autoConnect();
                } else {
                    conn.connect({
                        username: 'test' + $.urlvars.u,
                        password: 'test' + $.urlvars.u + 'password'
                    });
                }
            });

            $(document).ready(function() {
                conn = new GoCastJS.StropheConnection({
                    boshurl: '/xmpp-httpbind',
                    xmppserver: 'dev.gocast.it',
                    statusCallback: function(status) {
                        if (Strophe.Status.CONNECTED === status) {
                            $(document).trigger('online', conn);
                        } else if (Strophe.Status.ATTACHED === status) {
                            conn.forgetReconnectInfo();
                            conn.disconnect();
                        } else if (Strophe.Status.TERMINATED === status) {
                            $(document).trigger('offline', conn);
                        }
                    }
                });

                $(document).trigger('offline');
            });
        </script>
    </head>
    <body>
        <div id="preview"></div>
        <div id="peer0"></div>
        <div id="peer1"></div>
    </body>
</html>