<!DOCTYPE html>
<html>
	<head>
		<title>Plugin Demo (libjingle rev: 247)</title>
		<script type="text/javascript">
			function onice(candidate) {
				if ('' !== candidate) {
					var c = JSON.parse(candidate.replace(/\r\n/, '')),
						plugin1 = document.getElementById('remotePlayer');
					console.log('Candidate: ', candidate);
					console.log('Candidate Obj: ', c);
					console.log('Result: ', plugin1.addIceCandidate(c.sdp_mid, c.sdp_mline_index, c.sdp));
				} else {
					console.log('Candidate: GATHERING DONE');
				}
			}
			function ongetusermediasuccess(stream) {
				var plugin1 = document.getElementById('remotePlayer');
				plugin1.onaddstream = function(stream) {
					console.log('Added Stream: ', stream.label)
					plugin1.source = stream;
				};
				plugin1.onremovestream = function(stream) {
					console.log('Rmved Stream: ', stream.label)
				};
				plugin1.init('remotePlayer', '', onice);
				plugin1.addStream(stream);
				plugin1.createOffer(function(desc) {
					console.log('CreateOffer: ', desc);
					plugin1.setLocalDescription('offer', desc, function() {
						console.log('SetLocalDescription Success');
						plugin1.setRemoteDescription('answer', desc, function() {
							console.log('SetRemoteDescription Success');
						}, function(error) {
							console.log('SetRemoteDescription: ', error);
						});
					}, function(error) {
						console.log('SetLocalDescription: ', error);
					});
				}, function(error) {
					console.log('CreateOffer: ', error);
				});
			}
			function onpluginload() {
				var plugin = document.getElementById('localPlayer'),
					constraints = {
						video: true,
						audio: true,
						videoconstraints: {
							webrtc: {
								mandatory: {
									minWidth: '640',
									maxWidth: '640',
									minHeight: '480',
									maxHeight: '480',
									minFrameRate: '14',
									maxFrameRate: '14'
								}
							}
						}
					};

				plugin.getUserMedia(constraints, function(stream) {
					console.log('Success: ', stream);
					plugin.init('localPlayer','',null);
					plugin.addStream(stream);
					plugin.createOffer(function(desc) {
						console.log('CreateOffer: ', desc);
						plugin.setLocalDescription('offer', desc, function() {
							console.log('SetLocalDescription: Success');
							plugin.source = stream;
							//plugin.width = constraints.videoconstraints.webrtc.mandatory.maxWidth;
							//plugin.height = constraints.videoconstraints.webrtc.mandatory.maxHeight;
							ongetusermediasuccess(stream);
						}, function(error) {
							console.log('SetLocalDescription: ', error);
						});
					}, function(error) {
						console.log('CreateOffer: ', error);
					});
				}, function(msg) {alert(msg);});
			}
		</script>
	</head>
	<body>
		<object id="localPlayer" type="application/x-gocastplayer" width="640" height="480">
		</object>
		<object id="remotePlayer" type="application/x-gocastplayer" width="640" height="480">
			<param name="onload" value="onpluginload"></param>
		</object>
	</body>
</html>