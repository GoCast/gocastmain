<!DOCTYPE html>
<html>
	<head>
		<title>PeerConnection API Test (JSEP)</title>
		<script type="text/javascript" src="peerconnection.js"></script>
		<script type="text/javascript">
			var localStream = null;
			var remoteStream = null;
			var peerConn = null;
			
			function ongetusermediasuccess() {
				peerConn = new GoCastJS.PeerConnection(
					new GoCastJS.PeerConnectionOptions(
						"STUN stun.l.google.com:19302",
						function(candidate, moreComing) {
							if(true === moreComing) {
								if("string" === typeof(candidate) && null !== candidate) {
									console.log("onicemessage: ", candidate);
									peerConn.ProcessIceMessage(candidate);
								}
							}
						},
						function(stream) {
							if("undefined" !== typeof(stream) && null !== stream) {
								console.log("onaddstream: added remote stream [" +
											stream.label + "]");
								remoteStream = stream;
							}
						},
						function(stream) {
							if("undefined" !== typeof(stream) && null !== stream) {
								console.log("onremovestream: removed remote stream [" +
											stream.label + "]");
								remoteStream = null;
							}
						},
						function() {
							console.log("PC[remoteVideo]: ", peerConn.ReadyState());
						},
						document.getElementById("remoteVideo")
					)
				);
				
				peerConn.AddStream(localStream);
				var offer = peerConn.CreateOffer({audio:true, video:true});				
				console.log("ongetusermediasuccess: offer = ", offer);
				
				peerConn.SetLocalDescription(
					"OFFER",
					offer,
					function() {
						peerConn.SetRemoteDescription("ANSWER", offer);
						peerConn.StartIce();		
					},
					function(message) {
						console.log("onsetlocalsdpfail: ", message);
					}
				);
			}
			
			function onLocalPlayerLoaded() {
				var options = new GoCastJS.UserMediaOptions(
					{audio: true, video: true},
					document.getElementById("localVideo")
				);

				GoCastJS.getUserMedia(
					options,
					function(stream) {
						var camera = document.getElementById("localVideo").videoinopts["default"];
						console.log("getUserMediaSuccess: ", stream);
						localStream = stream;
						var checkVol = GoCastJS.SetSpkVolListener(
							600,
							document.getElementById("localVideo"),
							function(newVolume) {
								console.log("New Volume: " + newVolume);
							}
						);
						var check = GoCastJS.SetVideoDevicesChangedListener(
							1000,
							document.getElementById("localVideo"),
							function(devicesAdded, devicesRemoved) {
								console.log("Added: ", devicesAdded);
								console.log("Removed: ", devicesRemoved);

								if(0 <= devicesRemoved.indexOf(camera) ||
								   camera !== document.getElementById("localVideo").videoinopts["default"]) {
									clearInterval(check);
									clearInterval(checkVol);
									peerConn.Deinit();
									document.getElementById("localVideo").deinit();
									onLocalPlayerLoaded();
								}
							}
						);
						ongetusermediasuccess();
					},
					function(message) {
						console.log("getUserMediaFailure: ", message);
					}
				);
			}
			
			function toggleMuteAudio() {
				if(null !== localStream) {
					localStream.audioTracks[0].enabled = 
						!(localStream.audioTracks[0].enabled);
				}
			}
			
			function toggleMuteVideo() {
				if(null !== localStream) {
					localStream.videoTracks[0].enabled = 
						!(localStream.videoTracks[0].enabled);
				}
			}			
		</script>
	</head>
	<body>
		<button id="toggleMuteAudio" onclick="javascript:toggleMuteAudio()">
			Toggle Mute Audio
		</button>
		<button id="toggleMuteVideo" onclick="javascript:toggleMuteVideo()">
			Toggle Mute Video
		</button>
		<div id="videoContainer">
			<object id="localVideo"
					type="application/x-gocastplayer"
					width="160"
					height="120">
				<param name="onload" value="onLocalPlayerLoaded"></param>
			</object>
			<object id="remoteVideo"
					type="application/x-gocastplayer"
					width="160"
					height="120">
			</object>
		</div>
	</body>
</html>