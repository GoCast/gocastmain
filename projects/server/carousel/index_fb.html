<!DOCTYPE html>
<html>
  <head>
    <title>GoCast Carousel</title>

    <link rel='stylesheet' href='http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.0/themes/cupertino/jquery-ui.css'>
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js'></script>
    <script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.js'></script>

    <script src="/scripts/strophe.js" type="text/javascript"></script>
    <script src='/scripts/strophe.muc.js'></script>

    <script src="/scripts/callcast.js" type="text/javascript"></script>

  </head>
</html>
<body>
  <div id="fb-root"></div>
  <script>
    // Load the SDK Asynchronously
    //jk what is optimum place to load?
    //jk why async load?
    (function(d){
       var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
       js = d.createElement('script'); js.id = id; js.async = true;
       js.src = "http://connect.facebook.net/en_US/all.js";
       d.getElementsByTagName('head')[0].appendChild(js);
     }(document));

    window.fbAsyncInit = function() {
      FB.init({
        appId      : '458515917498757', // App ID
        status     : true, // check login status
        cookie     : true, // enable cookies to allow the server to access the session
        xfbml      : true,  // parse XFBML
		oauth	   : true,
      });

      FB.getLoginStatus(function(response) {
        if (response.status == "connected") {
          $(document).trigger("FacebookConnected", response.authResponse)
//	  console.log('authResponse-Object', response.authResponse);
//	  console.log('accessToken', response.authResponse.accessToken);
	  globalAuthResponse = response.authResponse;
//RMW	  $(document).trigger("connected");	// Let peek know...
        } else {
          $(document).trigger("NotConnectedToFacebook")
        }
      });

		// listen for and handle auth.statusChange events
		FB.Event.subscribe('auth.statusChange', function(response) {
		  if (response.authResponse) {
			//
			// NOTE: These two represent the keys to the kingdom. The signed response and the id.
			//
			globalFBSR = response.authResponse.signedRequest;
			globalFBID = response.authResponse.id;

			// user has auth'd your app and is logged into Facebook
			FB.api('/me', function(me){
			  if (me.name) {
				document.getElementById('auth-displayname').innerHTML = me.name;
				globalFBName = me.name;

				//
				// NOTE: These functions really should not be called here - they should be called
				//       on plugin loaded / ready.
				//       For this unit-test-style, this is fine.
				//
				Callcast.SetNickname(me.name);
				// Now login anonymously
				Callcast.connect(Callcast.CALLCAST_XMPPSERVER, "");

			  }
			})
			document.getElementById('auth-loggedout').style.display = 'none';
			document.getElementById('auth-loggedin').style.display = 'block';
		  } else {

		  	Callcast.disconnect();

			// user has not auth'd your app, or is not logged into Facebook
			document.getElementById('auth-loggedout').style.display = 'block';
			document.getElementById('auth-loggedin').style.display = 'none';

		  }
		});

		// respond to clicks on the login and logout links
		document.getElementById('auth-loginlink').addEventListener('click', function(){
		  FB.login();
		});
		document.getElementById('auth-logoutlink').addEventListener('click', function(){
		  FB.logout();
		});
		document.getElementById('auth-skip').addEventListener('click', function(){
			$('#nickname_dialog').dialog({
				autoOpen: true,
				draggable: false,
				modal: true,
				title: 'Please set your own Nickname',
				buttons: {
					"Set Nickname": function () {
						Callcast.connect(Callcast.CALLCAST_XMPPSERVER, "");	// Anonymous login.

						if ($('#nickname').val())
							Callcast.SetNickname($('#nickname').val());

						// Can also do something with $('#email').val()

						$(this).dialog('close');
					}
				}
			});
		});

    };

	$(document).bind('connected', function () {
		console.log("Connected.");

		var pres = $pres({to: 'switchboard_gocastfriends@video.gocast.it', intro_sr: globalFBSR})
			.c('x',{xmlns: 'http://jabber.org/protocol/muc'});

		// Now that we're connected, let's send our presence info to the switchboard and FB info.
		// Note - we're going to send our INTRO_SR buried in our presence.
		//        This way, the switchboard will know who we are on facebook when our presence is seen.
		Callcast.connection.send(pres);

		var room_to_create = $.getUrlVar("roomname");
		if (!room_to_create)
			room_to_create = Callcast.nick.replace(/ /g, '');

		// Getting rid of trailing '#' on URL if it is there. This is only because of the way
		// this sample is written.
		Callcast.CreateUnlistedAndJoin(room_to_create.replace(/#/g, ''));
	});

	$.extend({
	getUrlVars: function(){
	 var vars = [], hash;
	 var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
	 for(var i = 0; i < hashes.length; i++)
	 {
	   hash = hashes[i].split('=');
	   vars.push(hash[0]);
	   vars[hash[0]] = hash[1];
	 }
	 return vars;
	},
	getUrlVar: function(name){
	 return $.getUrlVars()[name];
	}
	});
  </script>
      <div id="auth-status">
        <div id="auth-loggedout">
	        Use your Facebook Login with a simple click! <a href="#" id="auth-loginlink">Login</a>
			<div id="no-facebook">
				<p/>Use the product without Facebook Login - <a href="#" id="auth-skip">Skip-Facebook</a>
			</div>
        </div>
        <div id="auth-loggedin" style="display:none">
          Hi, <span id="auth-displayname"></span>
        (<a href="#" id="auth-logoutlink">logout</a>)
	    </div>
    </div>

    <!-- login dialog -->
    <div id='nickname_dialog' style="display:none">
      <label>Nickname:</label><input type='text' id='nickname'>
      <label>Email (optional):</label><input type='text' id='email'>
    </div>

</body>
