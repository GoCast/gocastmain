<html>
    <head>
        <title>test-rwolff</title>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.0/themes/cupertino/jquery-ui.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.js"></script>
        <script src="http://dev.gocast.it/scripts/jquery.base64.min.js"></script>
        <script src="http://dev.gocast.it/scripts/strophe.js"></script>
        <script src="http://dev.gocast.it/scripts/strophe.muc.js"></script>
        <script src="js/ibb.js"></script>
        <script src="js/callcast.js"></script>
        <script type="text/javascript" src="cordova-2.2.0.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
    </head>
    <body bgcolor=#cccccc>

        Login

        <script>
            var chosenNick = 'iostest-client';
            var chosenRoom = 'iostest';
//            var whiteBoardSpotNumber = -1;

            var app1 = {
                /* 1: debug, 2: info, 3: warning, 4: error, 5: fatal. */

                log: function(logLevel, logMsg)
                {
                    var labels = ['', 'DEBUG', 'INFO', 'WARNING', 'ERROR', 'FATAL'],
                    now = new Date(),
                    logText = now.toTimeString().split(' ')[0] + ' ' + labels[logLevel] + ' ' + logMsg,
                    msg;
                    if (window.console)
                    {
                        console[['', 'log', 'info', 'warn', 'error', 'error'][logLevel]](logText);
                    }

                    /* For fatal errors pop-up an alert */

                    if (logLevel >= 5)
                    {
                        msg = 'FATAL ERROR\n\n' + logMsg;
                        alert(msg);
                    }

                    if ('undefined' !== typeof(Callcast) &&
                        'undefined' !== typeof(Callcast.log)) {
                        Callcast.log(' ' + labels[logLevel] + ': ' + logMsg);
                    }
                }, /* app1.log() */

                nickInUse: function(nick)
                {
                    log(2, "Nick in use.");
                },

            }; /* app1 */

            function onConnectionStatus(statusStr)
            {
                console.log("onConnectionStatus(" + statusStr + ")");

                if (statusStr.toLowerCase() === 'connected' || statusStr.toLowerCase() === 're-attached')
                {
                    Callcast.SetNickname(chosenNick);

                    Callcast.CreateUnlistedAndJoin(chosenRoom, function(new_name) {
                                                   console.log('Joined room successfully. Next?');

                                                   cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "loggedIn", [ "" ]);

                                                   }, function() {
                                                   alert('failed to join room.');
                                                   });
                }

            }

            function onNicknameInUse(nick)
            {
                cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "onNicknameInUse", [ "" ]);
                console.log("onNicknameInUse(" + nick + ")");
                app1.nickInUse(nick);
            }

            function assignSpotForParticipant(nick)
            {
                cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "addSpotForParticipant", [ "" ]);
                console.log("assignSpotForParticipant(" + nick + ")");
            }

            function unassignSpotForParticipant(nick)
            {
                cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "removeSpotForParticipant", [ "" ]);
                console.log("unassignSpotForParticipant(" + nick + ")");
            }

            function doSpot(info)
            {
                var cmds, numstrokes, stroke;

                if (info.spottype === 'whiteBoard')
                {
                    if (info.image)
                    {
                        console.log('Image Given. Must create canvas/image as starting point.');
                        cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "loadImageURL", [ info.spotnumber.toString(), info.image.toString() ]);
                    }

                    if (info.strokes)
                    {
                        cmds = JSON.parse(info.strokes);

                        numstrokes = cmds.strokes.length;
                        if (numstrokes) {
                            console.log(numstrokes + ' strokes to apply:', cmds.strokes);
                        }
                    }

                    if (info.stroke)
                    {
                        var i, cmd;

                        stroke = JSON.parse(info.stroke);

                        for (i = 0; i < stroke.length; i += 1)
                        {
                            switch (stroke[i].name)
                            {
                                case "save":
//                                    this.wbCtx.save();
//                                    this.settings.applyJson(cmdArray[i].settings, this.wbCtx);
                                                    cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "save", [ info.spotnumber.toString(), stroke[i].settings.strokeStyle, stroke[i].settings.lineWidth.toString() ]); break;
                                case "restore":     cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "restore", [ "" ]); break;
                                case "beginPath":   cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "beginPath", [ "" ]); break;
                                case "closePath":   cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "closePath", [ "" ]); break;
                                case "moveTo":      cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "moveTo", [ info.spotnumber.toString(), stroke[i].x.toString(), stroke[i].y.toString() ]); break;
                                case "lineTo":      cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "lineTo", [ info.spotnumber.toString(), stroke[i].x.toString(), stroke[i].y.toString() ]); break;
                                case "stroke":      cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "stroke", [ info.spotnumber.toString() ]); break;
                                default: throw "WhiteBoard.doCommand unknown cmd " + cmdArray[i].name; break;
                            }
                        }

//                        document.writeln('Single stroke to apply:', stroke, '<BR>');
                        console.log('Single stroke to apply:', stroke);
                    }
                }
            }

            function onAddSpot(data)
            {
                console.log("onAddSpot ", data);
                cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "addSpot", [ data.spottype.toString(), data.spotnumber.toString() ]);
                if (data.spottype === 'whiteBoard')
                {
//                    whiteBoardSpotNumber = data.spotnumber;
//                    console.log("*** data.spotnumber = " + data.spotnumber.toString());
                    doSpot(data);
                }
            }

            function onSetSpot(data)
            {
                cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "setSpot", [ "" ]);
                console.log("onSetSpot ", data);
                if (data.spottype === 'whiteBoard') {
                    doSpot(data);
                }
            }

            function onRemoveSpot(data)
            {
                cordova.exec(function(winParam) {}, function(error) {}, "GCICallcast", "removeSpot", [ data.spotnumber.toString() ]);
                console.log("onRemoveSpot ", data);
            }

            function setChosenNick(newNick)
            {
                chosenNick = newNick;
            }

            function setChosenRoom(newRoom)
            {
                chosenRoom = newRoom;
            }

            function startCallcast(newNick, newRoom)
            {
                setChosenNick(newNick);
                setChosenRoom(newRoom);

                $(window).bind('beforeunload', function() {
                               console.log('On before unload.');
                               Callcast.LeaveSession();
                               });

                Callcast.InitOverride({ CALLCAST_XMPPSERVER: 'dev.gocast.it',
                                      CALLCAST_ROOMS: 'conference.dev.gocast.it',
                                      AT_CALLCAST_ROOMS: '@conference.dev.gocast.it',
                                      STUNSERVER: 'dev.gocast.it', STUNSERVERPORT: 19302,
                                      FEEDBACK_BOT: 'feedback_bot_dev@dev.gocast.it',
                                      ROOMMANAGER: 'roommanager@dev.gocast.it/roommanager',
                                      SWITCHBOARD_FB: 'switchboard_dev@dev.gocast.it',
                                      LOGCATCHER: 'logcatcher@dev.gocast.it/logcatcher',
                                      });
/*
 setCallbackForAddSpot
 setCallbackForRemoveSpot
 setCallbackForSetSpot
 setCallbackForAddSpotForParticipant
 setCallbackForAddPluginToParticipant
 setCallbackForRemovePluginFromParticipant
 setCallbackForRemoveSpotForParticipant
 setCallbackForAddCarouselContent
 setCallbackForRemoveCarouselContent
 setCallbackForCallback_ConnectionStatus
 setCallbackForCallback_OnEffectApplied
 setCallbackForCallback_OnNicknameInUse
 setCallbackForReadyState
 */
                Callcast.setCallbackForAddSpot(onAddSpot);
                Callcast.setCallbackForRemoveSpot(onRemoveSpot);
                Callcast.setCallbackForSetSpot(onSetSpot);

                Callcast.setCallbackForAddSpotForParticipant(assignSpotForParticipant);
                Callcast.setCallbackForRemoveSpotForParticipant(unassignSpotForParticipant);

                Callcast.setCallbackForCallback_ConnectionStatus(onConnectionStatus);
                Callcast.setCallbackForCallback_OnNicknameInUse(onNicknameInUse);

                Callcast.connect(Callcast.CALLCAST_XMPPSERVER, '');
            }

            function sendStroke(stroke, theSpotNumber)
            {
                console.log("sendStroke ", stroke);
                Callcast.SendSingleStroke({stroke: JSON.stringify(stroke), spotnumber: theSpotNumber});
            }

            function realDrawLine(theSpotNumber, newColor, pensize, stx, sty, enx, eny)
            {
                var stroke;

                console.log("*** Beginning of realDrawLine!");

                stroke = [];

                stroke.push({name: 'save', settings: { colorName: 'dontcare', lineWidth: pensize.toString(), strokeStyle: newColor, lineJoin: 'round' } });
                stroke.push({name: 'beginPath'});

                stroke.push({name: 'moveTo', x: stx, y: sty }); // make start point end of last stroke
                stroke.push({name: 'lineTo', x: enx, y: eny }); // make start point end of last stroke

                stroke.push({name: 'stroke'}); // stroke lines
                stroke.push({name: 'restore'}); // finish command
                self.sendStroke(stroke, theSpotNumber);        // send it

                console.log("*** Reached end of realDrawLine!");
            }

            </script>
        <div class="app">
            <h1>Apache Cordova</h1>
            <div id="deviceready" class="blink">
                <p class="event listening">Connecting to Device</p>
                <p class="event received">Device is Ready</p>
            </div>
        </div>
        <script type="text/javascript">
            app2.initialize();
//            $(document).ready(startCallcast());
        </script>
    </body>
</html>

